# Data Contracts: DFM PoC — Ingestion Pipeline
#
# This file defines the key data contracts for the ingestion pipeline.
# Platform: Microsoft Fabric Lakehouse (Delta tables + OneLake Files)
# This is a batch data pipeline contract — not an OpenAPI spec.
#
# Sections:
#   1. run_input_contract   — parameters and landing zone structure for a run
#   2. canonical_holdings   — core Delta table schema
#   3. validation_events    — validation result Delta table schema
#   4. report_1             — Report 1 CSV schema (per DFM)
#   5. report_2             — Report 2 roll-up CSV schema
#   6. reconciliation_summary — JSON file structure

# ─────────────────────────────────────────────────────────────────────────────
# 1. RUN INPUT CONTRACT
# ─────────────────────────────────────────────────────────────────────────────
run_input_contract:
  description: >
    Parameters and file system layout required to trigger a valid pipeline run
    via nb_run_all.
  parameters:
    period:
      type: string
      format: "YYYY-MM"
      example: "2025-12"
      required: true
      description: The valuation period to process. One period per run.
    run_id:
      type: string
      format: "YYYYMMDDTHHmmssZ"
      example: "20251231T142300Z"
      required: false
      description: >
        UTC timestamp generated by nb_run_all at run start.
        Callers do not supply this value; it is auto-generated.
  landing_zone:
    path_template: "/Files/landing/period={period}/dfm={dfm_id}/source/"
    dfm_ids:
      - brown_shipley
      - wh_ireland
      - pershing
      - castlebay
    behaviour:
      - "Missing folder for a DFM is treated as NO_FILES for that DFM; pipeline continues."
      - "Multiple files of the same role are allowed; row-hash de-duplication prevents double-counting."
      - "Unexpected files in the source folder are ignored."
  config_files_required:
    - "/Files/config/dfm_registry.json"
    - "/Files/config/raw_parsing_config.json"
    - "/Files/config/rules_config.json"
    - "/Files/config/currency_mapping.json"
    - "/Files/config/fx_rates.csv"

# ─────────────────────────────────────────────────────────────────────────────
# 2. CANONICAL_HOLDINGS SCHEMA
# ─────────────────────────────────────────────────────────────────────────────
canonical_holdings:
  description: >
    Core Delta table. One row per security holding per source row per DFM per run.
    Partitioned by period and dfm_id.
  columns:
    - name: period
      type: string
      nullable: false
      description: "YYYY-MM run period."
    - name: run_id
      type: string
      nullable: false
      description: "UTC timestamp run identifier."
    - name: dfm_id
      type: string
      nullable: false
      enum: [brown_shipley, wh_ireland, pershing, castlebay]
    - name: dfm_name
      type: string
      nullable: false
    - name: source_file
      type: string
      nullable: false
      description: "Original filename from landing zone."
    - name: source_sheet
      type: string
      nullable: true
      description: "Excel sheet name; null for CSV sources."
    - name: source_row_id
      type: string
      nullable: false
      description: "Row identifier within source file (e.g., row_42)."
    - name: policy_id
      type: string
      nullable: false
    - name: policy_id_type
      type: string
      nullable: false
      enum: [IH, DFM]
    - name: dfm_policy_id
      type: string
      nullable: true
    - name: security_id
      type: string
      nullable: true
    - name: isin
      type: string
      nullable: true
    - name: other_security_id
      type: string
      nullable: true
    - name: id_type
      type: string
      nullable: true
    - name: asset_name
      type: string
      nullable: true
    - name: holding
      type: decimal(28,8)
      nullable: false
      constraints: ">= 0"
    - name: local_bid_price
      type: decimal(28,8)
      nullable: false
    - name: local_currency
      type: string
      nullable: false
      description: "ISO 4217 currency code."
    - name: fx_rate
      type: decimal(28,8)
      nullable: true
      description: "FX rate to GBP; null when local_currency == GBP."
    - name: cash_value_gbp
      type: decimal(28,8)
      nullable: false
      description: "Cash value in GBP; defaults to 0 when not available."
    - name: bid_value_gbp
      type: decimal(28,8)
      nullable: true
      description: "Bid value in GBP; null when FX conversion is unavailable."
    - name: accrued_interest_gbp
      type: decimal(28,8)
      nullable: false
      description: "Accrued interest in GBP; defaults to 0 when not available."
    - name: report_date
      type: date
      nullable: true
      description: "Valuation date from source; null if not parseable or inferable."
    - name: ingested_at
      type: timestamp
      nullable: false
    - name: row_hash
      type: string
      nullable: false
      description: "SHA-256 of deterministic source fields. Used for MERGE upsert de-duplication."
    - name: data_quality_flags
      type: array<string>
      nullable: false
      description: >
        One or more of: CURRENCY_ASSUMED_GBP, FX_NOT_AVAILABLE, FX_RATE_ASSUMED,
        PRICE_ABSENT, DATE_FROM_FILENAME, ACQ_COST_UNPARSEABLE,
        CASH_DEFAULTED, ACCRUED_DEFAULTED, CURRENCY_UNKNOWN.
        Empty array [] is valid.
  deduplication:
    method: MERGE upsert
    match_key: row_hash
    behaviour: "WHEN MATCHED → skip; WHEN NOT MATCHED → insert"

# ─────────────────────────────────────────────────────────────────────────────
# 3. VALIDATION_EVENTS SCHEMA
# ─────────────────────────────────────────────────────────────────────────────
validation_events:
  description: >
    One row per rule evaluation result. Written by nb_validate for each rule applied
    to each row (or policy) in canonical_holdings / policy_aggregates.
  columns:
    - name: period
      type: string
      nullable: false
    - name: run_id
      type: string
      nullable: false
    - name: event_time
      type: timestamp
      nullable: false
    - name: dfm_id
      type: string
      nullable: false
    - name: dfm_name
      type: string
      nullable: false
    - name: policy_id
      type: string
      nullable: false
    - name: security_id
      type: string
      nullable: true
      description: "Null for policy-level rules (VAL_001)."
    - name: rule_id
      type: string
      nullable: false
      enum: [MV_001, DATE_001, VAL_001, MAP_001]
    - name: severity
      type: string
      nullable: false
      enum: [stop, exception, warning]
    - name: status
      type: string
      nullable: false
      enum: [fail, not_evaluable]
    - name: details_json
      type: string
      nullable: false
      description: >
        JSON object. For MV_001: {"computed_mv": ..., "reported_mv": ...,
        "abs_diff": ..., "pct_diff": ...}.
        For not_evaluable: {"reason": "..."}.
    - name: source_file
      type: string
      nullable: true

# ─────────────────────────────────────────────────────────────────────────────
# 4. REPORT 1 SCHEMA (per DFM CSV)
# ─────────────────────────────────────────────────────────────────────────────
report_1:
  description: >
    Per-DFM validation summary CSV. One file per DFM per run.
    Path: /Files/output/period={period}/run_id={run_id}/report1_{dfm_id}.csv
  columns:
    - name: dfm_id
      type: string
      nullable: false
    - name: policy_id
      type: string
      nullable: false
    - name: rule_id
      type: string
      nullable: false
    - name: severity
      type: string
      nullable: false
    - name: status
      type: string
      nullable: false
    - name: count
      type: integer
      nullable: false
      description: "Number of events with this (policy_id, rule_id, severity, status) combination."
    - name: mv_computed
      type: float
      nullable: true
      description: "Populated for MV_001 fail rows only."
    - name: mv_reported
      type: float
      nullable: true
    - name: mv_abs_diff
      type: float
      nullable: true
    - name: mv_pct_diff
      type: float
      nullable: true

# ─────────────────────────────────────────────────────────────────────────────
# 5. REPORT 2 SCHEMA (roll-up CSV)
# ─────────────────────────────────────────────────────────────────────────────
report_2:
  description: >
    Cross-DFM roll-up CSV. One file per run.
    Path: /Files/output/period={period}/run_id={run_id}/report2_rollup.csv
  columns:
    - name: dfm_id
      type: string
      nullable: false
    - name: rule_id
      type: string
      nullable: false
    - name: severity
      type: string
      nullable: false
    - name: status
      type: string
      nullable: false
    - name: count
      type: integer
      nullable: false
    - name: top_policy_id
      type: string
      nullable: true
      description: "Policy with the highest exception count for this (dfm_id, rule_id) pair."
    - name: top_policy_exception_count
      type: integer
      nullable: true

# ─────────────────────────────────────────────────────────────────────────────
# 6. RECONCILIATION_SUMMARY.JSON STRUCTURE
# ─────────────────────────────────────────────────────────────────────────────
reconciliation_summary:
  description: >
    JSON file written to the run output folder.
    Path: /Files/output/period={period}/run_id={run_id}/reconciliation_summary.json
  schema:
    run_id:
      type: string
      description: "UTC timestamp run identifier."
    period:
      type: string
      description: "YYYY-MM run period."
    generated_at:
      type: string
      format: ISO 8601 datetime
    dfm_summary:
      type: array
      items:
        dfm_id:
          type: string
          enum: [brown_shipley, wh_ireland, pershing, castlebay]
        canonical_row_count:
          type: integer
          description: "Rows in canonical_holdings for this dfm_id and run_id."
        total_cash_value_gbp:
          type: number
          description: "Sum of cash_value_gbp from policy_aggregates."
        total_bid_value_gbp:
          type: number
          description: "Sum of bid_value_gbp from policy_aggregates (nulls treated as 0)."
        total_accrued_interest_gbp:
          type: number
          description: "Sum of accrued_interest_gbp from policy_aggregates."
  example:
    run_id: "20251231T142300Z"
    period: "2025-12"
    generated_at: "2025-12-31T14:23:05Z"
    dfm_summary:
      - dfm_id: "wh_ireland"
        canonical_row_count: 1250
        total_cash_value_gbp: 0.0
        total_bid_value_gbp: 45231876.50
        total_accrued_interest_gbp: 0.0
      - dfm_id: "pershing"
        canonical_row_count: 843
        total_cash_value_gbp: 0.0
        total_bid_value_gbp: 31087452.00
        total_accrued_interest_gbp: 0.0
      - dfm_id: "castlebay"
        canonical_row_count: 312
        total_cash_value_gbp: 0.0
        total_bid_value_gbp: 8741200.75
        total_accrued_interest_gbp: 0.0
      - dfm_id: "brown_shipley"
        canonical_row_count: 488
        total_cash_value_gbp: 125000.00
        total_bid_value_gbp: 22340875.25
        total_accrued_interest_gbp: 0.0
